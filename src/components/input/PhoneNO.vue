<template>
  <label for='phone'>{{ $t('MSG_PHONE_NO') }}</label>
  <div class='row'>
    <CountrySelector class='code' v-model:country='country' />
    <input
      type='text'
      id='phone'
      name='phone'
      :required='required'
      :placeholder='$t("MSG_PHONE_NO_PLACEHOLDER")'
      :class='[ error ? "error" : "" ]'
      v-model='myValue'
      @focus='onFocus'
      @blur='onBlur'
    >
  </div>
  <div class='error-message'>
    <span>{{ error ? $t('MSG_PHONE_TIP') : '' }}</span>
  </div>
</template>

<script setup lang='ts'>
import { defineProps, toRef, defineEmits, watch, ref, defineAsyncComponent } from 'vue'
import { appcountry } from 'src/npoolstore'

interface Props {
  value: string
  error: boolean
  required: boolean
}

const CountrySelector = defineAsyncComponent(() => import('src/components/lang/CountrySelector.vue'))

const props = defineProps<Props>()
const error = toRef(props, 'error')
const value = toRef(props, 'value')
const required = toRef(props, 'required')

const myValue = ref(value.value)
const country = ref(undefined as unknown as appcountry.Country)

const emit = defineEmits<{(e: 'update:value', value: string): void;
  (e: 'focus'): void;
  (e: 'blur'): void;
}>()

watch([myValue, () => country.value?.Code], () => {
  emit('update:value', country.value?.Code?.replace(/ /g, '') + myValue.value?.replace(/ /g, ''))
  onFocus()
  onBlur()
})

const onFocus = () => {
  emit('focus')
}

const onBlur = () => {
  emit('blur')
}

</script>

<style lang='sass' scoped>
input
  margin: 8px 0 4px -120px
  padding-left: 120px
  max-height: 45px

.code
  width: 120px
  margin-top: 8px
  max-height: 45px
</style>
